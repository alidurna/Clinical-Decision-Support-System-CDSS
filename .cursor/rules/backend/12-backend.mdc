---
description: Backend kurallarÄ± â€” Java Spring Boot, API Gateway, mikro servis standartlarÄ± (Google 2026 Standards)
globs: backend/**/*
alwaysApply: false
---

# ğŸ”§ Backend KurallarÄ±

**Versiyon:** 2.0.0 â€” Google 2026 Standards
**Ã–ncelik:** ğŸ”´ P0 â€” Kritik
**Kapsam:** `backend/` (API Gateway + Mikro Servisler)

---

## Kapsam ve Teknoloji

- **API Gateway:** `backend/api-gateway` â€” port 8080, tek giriÅŸ noktasÄ±.
- **Mikro servisler:** auth-service (8081), patient-service (8082), doctor-service (8083), notification-service (8084).
- **Teknoloji:** Java 17+, Spring Boot, Spring Cloud Gateway.
- **VeritabanÄ±:** PostgreSQL (servis baÅŸÄ±na ayrÄ± DB).

---

## Route YapÄ±sÄ± (API Gateway)

| Path | Servis | Port | AÃ§Ä±klama |
|------|--------|------|----------|
| `/api/auth/**` | auth-service | 8081 | Kimlik doÄŸrulama |
| `/api/patients/**` | patient-service | 8082 | Hasta yÃ¶netimi |
| `/api/doctors/**` | doctor-service | 8083 | Doktor yÃ¶netimi |
| `/api/notifications/**` | notification-service | 8084 | Bildirimler |
| `/api/ai/**` | ai-service | 5000 | AI/ML servisi |

Yeni route eklerken `api-gateway` `application.yml`'e route ekle; path **kebab-case**, **Ã§oÄŸul** isim.

---

## Paket ve SÄ±nÄ±f YapÄ±sÄ±

### Paket YapÄ±sÄ±
```java
com.cdss.<servis>/
â”œâ”€â”€ config/           â†’ KonfigÃ¼rasyon sÄ±nÄ±flarÄ±
â”œâ”€â”€ controller/       â†’ REST Controller
â”œâ”€â”€ service/          â†’ Ä°ÅŸ mantÄ±ÄŸÄ±
â”œâ”€â”€ repository/       â†’ VeritabanÄ± eriÅŸimi
â”œâ”€â”€ model/            â†’ Entity sÄ±nÄ±flarÄ±
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ request/      â†’ Ä°stek DTO'larÄ±
â”‚   â””â”€â”€ response/     â†’ YanÄ±t DTO'larÄ±
â”œâ”€â”€ exception/        â†’ Ã–zel exception'lar
â”œâ”€â”€ security/         â†’ Security config, filter
â””â”€â”€ util/             â†’ YardÄ±mcÄ± sÄ±nÄ±flar
```

### Ä°simlendirme
- **Base package:** `com.cdss.<servis-adÄ±>` (Ã¶rn. `com.cdss.auth`)
- **Application sÄ±nÄ±fÄ±:** `*Application.java` (Ã¶rn. `AuthServiceApplication.java`)
- **Katmanlar:** controller â†’ service â†’ repository
- **Controller:** `*Controller`, **Service:** `*Service`, **Repository:** `*Repository`
- **DTO:** `*Request`, `*Response`
- Metodlar **camelCase**.

---

## API TasarÄ±mÄ±

### RESTful KurallarÄ±
| Metod | KullanÄ±m | Ã–rnek |
|-------|----------|-------|
| GET | Listele / Detay | `GET /api/patients`, `GET /api/patients/{id}` |
| POST | OluÅŸtur | `POST /api/patients` |
| PUT | TamamÄ±nÄ± gÃ¼ncelle | `PUT /api/patients/{id}` |
| PATCH | KÄ±smen gÃ¼ncelle | `PATCH /api/patients/{id}` |
| DELETE | Sil | `DELETE /api/patients/{id}` |

### YanÄ±t FormatÄ± (TutarlÄ± Wrapper)
```json
{
  "data": { ... },
  "message": "Ä°ÅŸlem baÅŸarÄ±lÄ±",
  "success": true,
  "timestamp": "2026-02-12T15:30:00Z"
}
```

### HTTP Durum KodlarÄ±
| Kod | Durum | KullanÄ±m |
|-----|-------|----------|
| 200 | OK | BaÅŸarÄ±lÄ± GET / PUT |
| 201 | Created | BaÅŸarÄ±lÄ± POST |
| 204 | No Content | BaÅŸarÄ±lÄ± DELETE |
| 400 | Bad Request | Validasyon hatasÄ± |
| 401 | Unauthorized | Kimlik doÄŸrulama hatasÄ± |
| 403 | Forbidden | Yetkilendirme hatasÄ± |
| 404 | Not Found | Kaynak bulunamadÄ± |
| 409 | Conflict | Ã‡akÄ±ÅŸma (duplicate vb.) |
| 500 | Internal Server Error | Sunucu hatasÄ± |

---

## GÃ¼venlik

### Kimlik DoÄŸrulama
- **JWT** token; auth-service token Ã¼retir/doÄŸrular.
- Gateway veya filter ile token kontrolÃ¼.
- Token sÃ¼resi: eriÅŸim â†’ 15dk, yenileme â†’ 7 gÃ¼n.

### Yetkilendirme
- Roller: `ADMIN`, `DOCTOR`, `PATIENT`.
- Endpoint seviyesinde `@PreAuthorize` veya `@Secured`.

### Veri GÃ¼venliÄŸi
- Åifre: **BCrypt hash**; dÃ¼z metin saklanmaz.
- Hassas alanlar **loglanmaz** (TC, telefon, ÅŸifre).
- **Input validasyonu:** Bean Validation (`@Valid`, `@NotBlank`, `@Email`).
- **CORS:** Sadece izin verilen frontend origin.

---

## VeritabanÄ±

### Kurallar
- Her servis **kendi veritabanÄ±** (database per service): `cdss_auth`, `cdss_patient`, `cdss_doctor`.
- **JPA/Hibernate**; entity'ler sadece ilgili serviste.
- **Migration:** Flyway veya Liquibase ile ÅŸema yÃ¶netimi.
- BaÄŸlantÄ± bilgisi **environment variable** (`DATABASE_URL`, `USERNAME`, `PASSWORD`).
- `application.yml`'de placeholder kullan, hardcode etme.

### Best Practices
- Index oluÅŸtur (sÄ±k sorgulanan alanlar).
- N+1 query probleminden kaÃ§Ä±n (JOIN FETCH veya EntityGraph).
- Soft delete tercih et (`isDeleted` flag).
- Audit: `createdAt`, `updatedAt`, `createdBy` alanlarÄ±.

---

## Loglama ve Hata YÃ¶netimi

### Loglama
- **SLF4J + Logback**; seviye: INFO (prod), DEBUG (geliÅŸtirme).
- KiÅŸisel veri **loglanmaz**.
- Request/Response loglarÄ±: correlation ID ile.

### Exception Handling
```java
@ControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity<ApiResponse> handleNotFound(ResourceNotFoundException ex) {
        return ResponseEntity.status(404).body(ApiResponse.error(ex.getMessage()));
    }
    
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ApiResponse> handleGeneral(Exception ex) {
        log.error("Unexpected error", ex);
        return ResponseEntity.status(500).body(ApiResponse.error("Sistem hatasÄ±"));
    }
}
```

- TutarlÄ± hata yanÄ±tÄ± (`@ControllerAdvice`).
- Stack trace **sadece geliÅŸtirme** ortamÄ±nda.
- Her Ã¶zel hata durumu iÃ§in **Ã¶zel exception** sÄ±nÄ±fÄ±.

---

## Servis Ä°letiÅŸimi

| Pattern | KullanÄ±m |
|---------|----------|
| REST (senkron) | AnlÄ±k yanÄ±t gerektiren istekler |
| Event-driven (asenkron) | Bildirimler, email gÃ¶nderimi |
| API Gateway | TÃ¼m dÄ±ÅŸ trafik buradan geÃ§er |

---

## Docker ve Deployment

```dockerfile
# Multi-stage build
FROM maven:3.9-eclipse-temurin-17 AS build
WORKDIR /app
COPY . .
RUN mvn clean package -DskipTests

FROM eclipse-temurin:17-jre-alpine
COPY --from=build /app/target/*.jar app.jar
EXPOSE 8081
ENTRYPOINT ["java", "-jar", "app.jar"]
```

- Her servis ayrÄ± **Docker container**.
- `docker-compose.yml` ile lokal orchestration.
- Health check endpoint: `/actuator/health`.
